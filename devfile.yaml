schemaVersion: 2.2.0
metadata:
  name: bitnet-development-workspace
  version: 1.0.0
  description: Development workspace for BitNet 1-bit LLM inference framework

components:
  # Main development container with required tools and dependencies
  - name: bitnet-dev
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-latest
      volumeMounts:
        - name: bitnet-storage
          path: /workspace
      memoryLimit: 4Gi
      memoryRequest: 2Gi
      cpuLimit: '2'
      cpuRequest: '1'
      mountSources: true
      env:
        - name: PYTHONUNBUFFERED
          value: '1'
      endpoints:
        - name: inference-svc
          targetPort: 8080
          exposure: public
          protocol: http
        - name: flexible-svc
          targetPort: 8081
          exposure: public
          protocol: http

  # Persistent storage for models and workspace data
  - name: bitnet-storage
    volume:
      size: 10Gi

commands:
  # Setup and build commands
  - id: install-dependencies
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: |
        git submodule update --init --recursive && \
        python3 -m pip install --user -r requirements.txt
      group:
        kind: build
        isDefault: true

  - id: build-bitnet
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: |
        mkdir -p build && cd build && \
        cmake .. -DCMAKE_BUILD_TYPE=Release && \
        make -j2
      group:
        kind: build

  # Development and testing commands
  - id: setup-python-env
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: python3 setup_env.py
      group:
        kind: run

  - id: run-inference
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: python3 run_inference.py
      group:
        kind: run

  - id: start-inference-server
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: python3 run_inference_server.py --port 8080
      group:
        kind: run

  - id: start-flexible-server
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: python3 run_server_flexible.py --port 8081
      group:
        kind: run

  # Utility commands
  - id: clean-build
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: rm -rf build/
      group:
        kind: build

  - id: check-dependencies
    exec:
      component: bitnet-dev
      workingDir: ${PROJECT_SOURCE}
      commandLine: |
        echo "Checking system dependencies..." && \
        python3 --version && \
        cmake --version && \
        gcc --version && \
        echo "Dependencies check complete"
      group:
        kind: test

events:
  # Post-start commands for development readiness
  postStart:
    - install-dependencies